# **异步日志性能测试**

关闭日志内存保护措施(实测开不开都一样).

测试程序：
```c++
///FileUtil.cc也要增加g_total变量，并且磁盘写多少字节增加多少

inline double timeDifference(Timestamp high, Timestamp low)
{
  int64_t diff = high.microSecondsSinceEpoch() - low.microSecondsSinceEpoch();
  return static_cast<double>(diff) / Timestamp::kMicroSecondsPerSecond;
}
extern unsigned long g_total;

void bench(const char* type)
{
  Timestamp start(Timestamp::now());

  int n = 1000*1000;
  const bool kLongLog = true;
  string empty = " ";
  string longStr(3000, 'X');
  longStr += " ";
  for (int i = 0; i < n; ++i)
  {
    LOG_TRACE << "Hello 0123456789" << " abcdefghijklmnopqrstuvwxyz"
             << (kLongLog ? longStr : empty)
             << i;
  }
  Timestamp end(Timestamp::now());
  double seconds = timeDifference(end, start);
  printf("%12s: %f seconds, %lu bytes, %10.2f msg/s, %.2f MiB/s\n",
         type, seconds, g_total, n / seconds, g_total / seconds / (1024 * 1024));
}

int main()
{
  getppid(); 

  LOG_TRACE << "trace";
  LOG_DEBUG << "debug";
  LOG_TRACE << "Hello";
  LOG_TRACE << "World";
  LOG_ERROR << "Error";
  LOG_TRACE << sizeof(Logger);
  LOG_TRACE << sizeof(LogStream);
  LOG_TRACE << sizeof(LogStream::Buffer);

  sleep(1);
  bench("nop");
}

```
短日志: 50字节信息 + 日志头尾60字节 总约110字节;  大约1.55us一条信息。

`irono.log: 29.485835 seconds, 2027036599 bytes,  678291.80 msg/s, 65.56 MiB/s`
`irono.log: 14.839170 seconds, 1008557340 bytes,  673892.14 msg/s, 64.82 MiB/s`

长日志: 2940字节信息 + 日志头尾60字节 总约3000字节

`irono.log: 3.635880 seconds, 2265893717 bytes,  275036.58 msg/s, 594.33 MiB/s`

# **框架性能测试**

## pingpong测试

测试程序写于irono/example/pingpong

目的是测试吞吐量，采用类似echo协议的方法。

(小插曲：文件描述符数内核限制8192，所以我一开始尝试10000的并发连接失败了，必须改内核参数增加文件描述符数量才能做10000并发连接)

因为总共核心8核，日志线程占一个核心，所以最多取了客户端3核心，服务器3核心

### g++优化等级O2, 标准取块大小4096，开启异步日志，单线程

* 单线程，1并发连接
   
`2021-12-04 22:11:04 DEBUG 315989  46.4466145833 MiB/s throughput -- client.cc:132`

* 单线程，10并发连接
  
`2021-12-04 22:32:48 DEBUG 317248  409.521484375 MiB/s throughput -- client.cc:132`

* 单线程，100并发连接

`2021-12-04 22:35:34 DEBUG 317490  429.7578125 MiB/s throughput -- client.cc:132`

* 单线程，1000并发连接

`2021-12-04 22:38:52 DEBUG 317831  335.7421875 MiB/s throughput -- client.cc:132`

* 单线程，10000并发连接

`2021-12-04 22:56:22 DEBUG 318988  339.98671875 MiB/s throughput -- client.cc:132`

### g++优化等级O2, 标准取块大小4096，开启异步日志，双线程

* 2线程，100并发连接
   
`2021-12-04 23:28:50 DEBUG 320377  456.803385417 MiB/s throughput -- client.cc:132`

* 2线程，1000并发连接

``

### g++优化等级O2, 标准取块大小16384，开启异步日志

* 单线程，1并发连接
  
`2021-12-04 22:16:02 DEBUG 316315  180.380208333 MiB/s throughput -- client.cc:132`